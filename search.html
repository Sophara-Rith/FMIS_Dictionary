<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dictionary Search</title>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }

            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }

            .search-container {
                background-color: white;
                border-radius: 8px;
                padding: 25px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 30px;
                position: relative;
            }

            .search-box {
                display: flex;
                position: relative;
            }

            .search-input {
                flex: 1;
                padding: 15px;
                font-size: 18px;
                border: 2px solid #ddd;
                border-radius: 8px;
                transition: border-color 0.3s;
            }

            .search-input:focus {
                outline: none;
                border-color: #3498db;
            }

            .search-options {
                display: flex;
                margin-top: 15px;
                gap: 20px;
                flex-wrap: wrap;
            }

            .option-group {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .option-label {
                font-weight: 600;
                font-size: 14px;
                color: #555;
            }

            select {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

            .checkbox-group {
                display: flex;
                gap: 15px;
            }

            .checkbox-item {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .suggestions-container {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: white;
                border: 1px solid #ddd;
                border-top: none;
                border-radius: 0 0 8px 8px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 10;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                display: none;
            }

            .suggestion-item {
                padding: 12px 15px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
            }

            .suggestion-item:last-child {
                border-bottom: none;
            }

            .suggestion-item:hover,
            .suggestion-item.active {
                background-color: #f0f7ff;
            }

            .suggestion-word {
                font-weight: 600;
            }

            .suggestion-translation {
                color: #7f8c8d;
            }

            .results-container {
                background-color: white;
                border-radius: 8px;
                padding: 25px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .word-card {
                border-bottom: 1px solid #eee;
                padding: 20px 0;
            }

            .word-card:last-child {
                border-bottom: none;
            }

            .word-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
            }

            .word-main {
                flex: 1;
            }

            .word-title {
                font-size: 24px;
                font-weight: 700;
                color: #2c3e50;
                margin: 0 0 5px 0;
            }

            .word-type {
                display: inline-block;
                font-size: 14px;
                background-color: #f1f1f1;
                padding: 3px 10px;
                border-radius: 12px;
                margin-right: 10px;
            }

            .word-translation {
                font-size: 20px;
                font-weight: 600;
                color: #e74c3c;
            }

            .definition-section {
                margin-bottom: 15px;
            }

            .definition-header {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 5px;
                color: #2c3e50;
            }

            .definition-content {
                padding-left: 10px;
            }

            .loading-indicator {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 10px;
                vertical-align: middle;
                display: none;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .no-results {
                text-align: center;
                padding: 40px 0;
                color: #7f8c8d;
            }

            .error-message {
                background-color: #ffecec;
                color: #e74c3c;
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 20px;
                display: none;
            }

            .pagination {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #eee;
            }

            .pagination-info {
                color: #7f8c8d;
                font-size: 14px;
            }

            .pagination-buttons {
                display: flex;
                gap: 10px;
            }

            .pagination-button {
                background-color: #f1f1f1;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .pagination-button:hover {
                background-color: #e0e0e0;
            }

            .pagination-button:disabled {
                background-color: #f1f1f1;
                color: #bbb;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <h1>Khmer-English Dictionary</h1>

        <div class="search-container">
            <div class="search-box">
                <input
                    type="text"
                    class="search-input"
                    id="searchInput"
                    placeholder="Type a word in English or Khmer..."
                    autocomplete="off"
                />
                <div class="loading-indicator" id="searchLoading"></div>
            </div>

            <div class="search-options">
                <div class="option-group">
                    <span class="option-label">Language:</span>
                    <select id="languageSelect">
                        <option value="ALL">All Languages</option>
                        <option value="kh">Khmer</option>
                        <option value="en">English</option>
                    </select>
                </div>

                <div class="option-group">
                    <span class="option-label">Search in:</span>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input
                                type="checkbox"
                                id="fieldWord"
                                value="word"
                                checked
                            />
                            <label for="fieldWord">Word</label>
                        </div>
                        <div class="checkbox-item">
                            <input
                                type="checkbox"
                                id="fieldDefinition"
                                value="definition"
                                checked
                            />
                            <label for="fieldDefinition">Definition</label>
                        </div>
                        <div class="checkbox-item">
                            <input
                                type="checkbox"
                                id="fieldExample"
                                value="example_sentence"
                            />
                            <label for="fieldExample">Example</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="suggestions-container" id="suggestionsContainer"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="results-container" id="resultsContainer">
            <!-- Results will be displayed here -->
        </div>

        <script>
            // API configuration
            const API_BASE_URL = "http://127.0.0.1:3030/api"; // Change this to your actual API domain

            // DOM elements
            const searchInput = document.getElementById("searchInput");
            const searchLoading = document.getElementById("searchLoading");
            const languageSelect = document.getElementById("languageSelect");
            const fieldWord = document.getElementById("fieldWord");
            const fieldDefinition = document.getElementById("fieldDefinition");
            const fieldExample = document.getElementById("fieldExample");
            const suggestionsContainer = document.getElementById(
                "suggestionsContainer"
            );
            const resultsContainer =
                document.getElementById("resultsContainer");
            const errorMessage = document.getElementById("errorMessage");

            // Variables for search state
            let searchTimeout = null;
            let currentSuggestionIndex = -1;
            let suggestions = [];
            let currentSearchState = {
                query: "",
                language: "ALL",
                searchFields: ["word", "definition", "example_sentence"],
                page: 1,
                perPage: 10,
                totalPages: 1,
            };

            // Event listeners
            searchInput.addEventListener("input", handleSearchInput);
            searchInput.addEventListener("keydown", handleKeyNavigation);
            languageSelect.addEventListener("change", updateSearchOptions);
            fieldWord.addEventListener("change", updateSearchOptions);
            fieldDefinition.addEventListener("change", updateSearchOptions);
            fieldExample.addEventListener("change", updateSearchOptions);

            // Initialize with empty results
            resultsContainer.innerHTML =
                '<div class="no-results">Type a word to search</div>';

            // Function to handle search input with debounce
            function handleSearchInput() {
                const query = searchInput.value.trim();

                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Reset suggestions
                currentSuggestionIndex = -1;

                // Hide suggestions if query is empty
                if (query.length === 0) {
                    suggestionsContainer.style.display = "none";
                    resultsContainer.innerHTML =
                        '<div class="no-results">Type a word to search</div>';
                    return;
                }

                // Show loading indicator
                searchLoading.style.display = "inline-block";

                // Set timeout for debounce (300ms)
                searchTimeout = setTimeout(() => {
                    // Get search options
                    const language = languageSelect.value;
                    const searchFields = getSelectedSearchFields();

                    // Update current search state
                    currentSearchState.query = query;
                    currentSearchState.language = language;
                    currentSearchState.searchFields = searchFields;
                    currentSearchState.page = 1;

                    // Fetch suggestions
                    fetchSearchResults();
                }, 300);
            }

            // Function to handle keyboard navigation
            function handleKeyNavigation(e) {
                // If suggestions are not displayed, return
                if (suggestionsContainer.style.display !== "block") {
                    return;
                }

                switch (e.key) {
                    case "ArrowDown":
                        e.preventDefault();
                        navigateSuggestion(1);
                        break;
                    case "ArrowUp":
                        e.preventDefault();
                        navigateSuggestion(-1);
                        break;
                    case "Enter":
                        e.preventDefault();
                        selectSuggestion(currentSuggestionIndex);
                        break;
                    case "Escape":
                        e.preventDefault();
                        suggestionsContainer.style.display = "none";
                        break;
                }
            }

            // Function to navigate through suggestions
            function navigateSuggestion(direction) {
                // Update current index
                const newIndex = currentSuggestionIndex + direction;

                // Check bounds
                if (newIndex >= 0 && newIndex < suggestions.length) {
                    // Remove active class from current suggestion
                    if (currentSuggestionIndex >= 0) {
                        document
                            .querySelector(
                                `.suggestion-item[data-index="${currentSuggestionIndex}"]`
                            )
                            .classList.remove("active");
                    }

                    // Update current index
                    currentSuggestionIndex = newIndex;

                    // Add active class to new suggestion
                    const activeItem = document.querySelector(
                        `.suggestion-item[data-index="${currentSuggestionIndex}"]`
                    );
                    activeItem.classList.add("active");

                    // Scroll into view if needed
                    activeItem.scrollIntoView({
                        block: "nearest",
                        behavior: "smooth",
                    });
                }
            }

            // Function to select a suggestion
            function selectSuggestion(index) {
                if (index >= 0 && index < suggestions.length) {
                    const selectedSuggestion = suggestions[index];

                    // Update search input
                    searchInput.value =
                        selectedSuggestion.word_en ||
                        selectedSuggestion.word_kh;

                    // Hide suggestions
                    suggestionsContainer.style.display = "none";

                    // Display the selected word details
                    displaySelectedWord(selectedSuggestion);
                }
            }

            // Function to update search options
            function updateSearchOptions() {
                // If there's text in the search input, trigger a new search
                if (searchInput.value.trim().length > 0) {
                    handleSearchInput();
                }
            }

            // Function to get selected search fields
            function getSelectedSearchFields() {
                const fields = [];

                if (fieldWord.checked) fields.push("word");
                if (fieldDefinition.checked) fields.push("definition");
                if (fieldExample.checked) fields.push("example_sentence");

                // Default to word if nothing selected
                return fields.length > 0 ? fields : ["word"];
            }

            // Function to fetch search results
            function fetchSearchResults(page = 1) {
                // Update page in current search state
                currentSearchState.page = page;

                // Show loading indicator
                searchLoading.style.display = "inline-block";

                // Build URL with query parameters
                let url = new URL(`${API_BASE_URL}/dictionary/search`);
                url.searchParams.append("query", currentSearchState.query);
                url.searchParams.append(
                    "language",
                    currentSearchState.language
                );
                url.searchParams.append("page", currentSearchState.page);
                url.searchParams.append("per_page", currentSearchState.perPage);

                // Add search fields (can be multiple)
                currentSearchState.searchFields.forEach((field) => {
                    url.searchParams.append("search_fields", field);
                });

                // Fetch API call
                fetch(url)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! Status: ${response.status}`
                            );
                        }
                        return response.json();
                    })
                    .then((data) => {
                        // Hide loading indicator
                        searchLoading.style.display = "none";

                        // Process results
                        if (data.responseCode === 200) {
                            // Store suggestions for keyboard navigation
                            suggestions = data.data.results;

                            // Update total pages in current search state
                            currentSearchState.totalPages =
                                data.data.total_pages;

                            // If this is the first search (page 1), show suggestions
                            if (currentSearchState.page === 1) {
                                displaySuggestions(data.data.results);
                            }

                            // Always display search results
                            displaySearchResults(data.data);
                        } else {
                            throw new Error(
                                data.message || "Unknown error occurred"
                            );
                        }
                    })
                    .catch((error) => {
                        // Hide loading indicator
                        searchLoading.style.display = "none";

                        // Show error message
                        errorMessage.textContent = `Error: ${error.message}`;
                        errorMessage.style.display = "block";
                        console.error("Search error:", error);
                    });
            }

            // Function to display suggestions
            function displaySuggestions(results) {
                // Clear previous suggestions
                suggestionsContainer.innerHTML = "";

                // If no results, hide suggestions
                if (results.length === 0) {
                    suggestionsContainer.style.display = "none";
                    return;
                }

                // Create suggestion items
                results.forEach((result, index) => {
                    const item = document.createElement("div");
                    item.className = "suggestion-item";
                    item.setAttribute("data-index", index);

                    const wordSpan = document.createElement("span");
                    wordSpan.className = "suggestion-word";
                    wordSpan.textContent = result.word_en || "";

                    const translationSpan = document.createElement("span");
                    translationSpan.className = "suggestion-translation";
                    translationSpan.textContent = result.word_kh || "";

                    item.appendChild(wordSpan);
                    item.appendChild(translationSpan);

                    // Add click event
                    item.addEventListener("click", () => {
                        selectSuggestion(index);
                    });

                    // Add mouseover event
                    item.addEventListener("mouseover", () => {
                        // Remove active class from current suggestion
                        if (currentSuggestionIndex >= 0) {
                            document
                                .querySelector(
                                    `.suggestion-item[data-index="${currentSuggestionIndex}"]`
                                )
                                .classList.remove("active");
                        }

                        // Update current index
                        currentSuggestionIndex = index;

                        // Add active class to this suggestion
                        item.classList.add("active");
                    });

                    suggestionsContainer.appendChild(item);
                });

                // Show suggestions
                suggestionsContainer.style.display = "block";
            }

            // Function to display search results
            function displaySearchResults(data) {
                // Clear error message
                errorMessage.style.display = "none";

                // If no results
                if (data.results.length === 0) {
                    resultsContainer.innerHTML =
                        '<div class="no-results">No results found. Try different search terms or filters.</div>';
                    return;
                }

                // Create HTML for results
                let html = "";

                // Add each result as a card
                data.results.forEach((entry) => {
                    html += `
                    <div class="word-card">
                        <div class="word-header">
                            <div class="word-main">
                                <h3 class="word-title">${
                                    entry.word_en || ""
                                }</h3>
                                <span class="word-type">${
                                    entry.word_en_type || ""
                                }</span>
                            </div>
                            <div class="word-translation">${
                                entry.word_kh || ""
                            }</div>
                        </div>

                        ${
                            entry.word_en_definition
                                ? `
                            <div class="definition-section">
                                <div class="definition-header">English Definition</div>
                                <div class="definition-content">${entry.word_en_definition}</div>
                            </div>
                        `
                                : ""
                        }

                        ${
                            entry.word_kh_definition
                                ? `
                            <div class="definition-section">
                                <div class="definition-header">Khmer Definition</div>
                                <div class="definition-content">${entry.word_kh_definition}</div>
                            </div>
                        `
                                : ""
                        }
                    </div>
                `;
                });

                // Add pagination
                html += `
                <div class="pagination">
                    <div class="pagination-info">
                        Showing ${data.results.length} of ${
                    data.total_results
                } results • Page ${data.page} of ${data.total_pages}
                    </div>
                    <div class="pagination-buttons">
                        <button class="pagination-button" id="prevPageBtn" ${
                            data.page <= 1 ? "disabled" : ""
                        }>Previous</button>
                        <button class="pagination-button" id="nextPageBtn" ${
                            data.page >= data.total_pages ? "disabled" : ""
                        }>Next</button>
                    </div>
                </div>
            `;

                // Update results container
                resultsContainer.innerHTML = html;

                // Add event listeners to pagination buttons
                const prevPageBtn = document.getElementById("prevPageBtn");
                const nextPageBtn = document.getElementById("nextPageBtn");

                if (prevPageBtn) {
                    prevPageBtn.addEventListener("click", () => {
                        if (currentSearchState.page > 1) {
                            fetchSearchResults(currentSearchState.page - 1);
                            // Scroll to top of results
                            resultsContainer.scrollIntoView({
                                behavior: "smooth",
                            });
                        }
                    });
                }

                if (nextPageBtn) {
                    nextPageBtn.addEventListener("click", () => {
                        if (currentSearchState.page < data.total_pages) {
                            fetchSearchResults(currentSearchState.page + 1);
                            // Scroll to top of results
                            resultsContainer.scrollIntoView({
                                behavior: "smooth",
                            });
                        }
                    });
                }
            }

            // Function to display a selected word
            function displaySelectedWord(wordData) {
                // Clear error message
                errorMessage.style.display = "none";

                // Create HTML for word details
                let html = `
                <div class="word-card">
                    <div class="word-header">
                        <div class="word-main">
                            <h3 class="word-title">${
                                wordData.word_en || ""
                            }</h3>
                            <span class="word-type">${
                                wordData.word_en_type || ""
                            }</span>
                        </div>
                        <div class="word-translation">${
                            wordData.word_kh || ""
                        }</div>
                    </div>

                    ${
                        wordData.word_en_definition
                            ? `
                        <div class="definition-section">
                            <div class="definition-header">English Definition</div>
                            <div class="definition-content">${wordData.word_en_definition}</div>
                        </div>
                    `
                            : ""
                    }

                    ${
                        wordData.word_kh_definition
                            ? `
                        <div class="definition-section">
                            <div class="definition-header">Khmer Definition</div>
                            <div class="definition-content">${wordData.word_kh_definition}</div>
                        </div>
                    `
                            : ""
                    }
                </div>
            `;

                // Update results container
                resultsContainer.innerHTML = html;
            }

            // Focus search input on page load
            window.addEventListener("load", () => {
                searchInput.focus();
            });
        </script>
    </body>
</html>
